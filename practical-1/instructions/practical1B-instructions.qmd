---
title: "Practical 1B - microbiota data"
subtitle: "NUTRIM microbiome & metabolome workshop"
author: David Barnett
date: last-modified
keep-md: false
theme: 
  light: flatly
  dark: darkly
format: html
embed-resources: true
code-block-border-left: true
code-block-bg: true
toc: true
toc-location: right
toc-depth: 4
toc-expand: 3
number-sections: true
number-depth: 3
fig-align: center
fig-dpi: 300
fig-width: 7.5
fig-height: 5
fig-responsive: true
code-tools: true
code-fold: false
code-link: true
lightbox: auto
cache: false
---

## Intro

Now we're going to look at the microbiota data.

::: {.callout-note collapse="true"}
### A note on sequence data processing

These data have already been processed into a table, counts of how often each sequence occurs in each sample.

It started as huge fastq text files, full of As, Cs, Ts and Gs, but we will not practice sequence data processing today, because it takes quite a long time to run.

If you generate your data with us at Medical Microbiology, we will run the latest processing approaches on our computational infrastructure and provide you with the processed data.

Nowadays we do amplicon sequencing with Illumina MiSeq, HiSeq, or similar technologies, and denoise the output with DADA2 to produce ASV count tables.

The example data we will use are a little older. The amplicons were sequenced with 454 pyrosequencing and clustered into OTUs, but the core principles of analysis remain the same.

And as you will see later today, the same approaches can also be applied to taxonomic abundance count tables obtained from shotgun metagenomic sequencing.
:::

First we're going to use the R skills we practised in part A to inspect this data.

::: {.callout-note collapse="true" appearance="simple"}
### SOLUTION: (read me?)

-   In this practical, solution blocks like this are available...

-   But try and write code independently before looking at the answer!

-   Attempting to recall knowledge or solve problems is proven to enhance learning.

-   So don't look unless you're really stuck! üí™
:::

After that, we'll take a look at some specialist R packages for microbiome analysis.

## Learning goals üí™

-   [blah](#blah)

## Load R packages üì¶

```{r}
library(readxl)
library(here)
library(tidyverse)
```

## Read and inspect data üîç

Read the metadata file from part 1A, using the RDS version.

```{r}
meta <- read_rds(file = here("data/papa2012/processed/all_metadata.rds"))
```

Read the count table: this is stored as a TSV (tab-separated variables) formatted text file.

```{r}
counts <- read_tsv(file = here("data/papa2012/papa2012_OTU_count_table.txt"))
```

```{r}
counts
```

**Your first challenge:** read the taxonomy table stored in `"data/papa2012/papa2012_taxonomy_table.txt"` (call the object `taxonomy`)

::: {.callout-note collapse="true" appearance="simple"}
#### SOLUTION:

```{r}
taxonomy <- read_tsv(file = here("data/papa2012/papa2012_taxonomy_table.txt"))
```

```{r}
taxonomy
```
:::

### Taxonomy table

Now practice inspecting the taxonomy table by completing the following tasks:

::: panel-tabset
##### Task 1

Check how many distinct genera there are. Tip: use `unique()` and `length()`

::: {.callout-note collapse="true" appearance="simple"}
##### SOLUTION:

```{r}
taxonomy$Genus %>%
  unique() %>%
  length()
```
:::

##### Task 2

How many OTUs are there in each Phylum? Tip: use `count()` or `table()`

::: {.callout-note collapse="true" appearance="simple"}
##### SOLUTION:

```{r}
taxonomy %>% count(Phylum)
```

```{r}
taxonomy$Phylum %>% table(useNA = "ifany")
```
:::

##### Task 3

What genera are in the phylum Actinobacteria? Tip: use `filter()`

::: {.callout-note collapse="true" appearance="simple"}
##### SOLUTION:

```{r}
taxonomy %>%
  filter(Phylum == "Actinobacteria") %>%
  count(Genus, sort = TRUE)
```

Or for just their names:

```{r}
taxonomy %>%
  filter(Phylum == "Actinobacteria") %>%
  pull(Genus) %>%
  unique()
```
:::
:::

### OTU count table

First let's plot a histogram of OTU number 1.

```{r, fig.width=8, fig.height=2}
counts %>% ggplot(aes(OTU_00001)) +
  geom_histogram(binwidth = 5)
```

Looks like there are a lot of zeros!

```{r}
table(OTU00001_has_0_counts = counts$OTU_00001 == 0, useNA = "ifany")
```

------------------------------------------------------------------------

Attempt the following tasks to explore further!

::: panel-tabset
##### Task 1

Use `filter()` to plot only the non-zero entries for OTU 1.

Try also using `+ scale_x_log10()` to transform the plot axis scale.

::: {.callout-note collapse="true" appearance="simple"}
##### SOLUTION:

```{r, fig.width=8, fig.height=2}
counts %>%
  filter(OTU_00001 != 0) %>%
  ggplot(aes(OTU_00001)) +
  geom_histogram(bins = 30) +
  scale_x_log10()
```
:::

##### Task 2

Use `mutate()` to create a temporary log-transformed variable `log_OTU1` and plot its distribution.

*Note that you can't do log(0), so you will need to add 1 to all values first, i.e.* `log10(OTU_00001 + 1)`

::: {.callout-note collapse="true" appearance="simple"}
##### SOLUTION:

```{r, fig.width=8, fig.height=2}
counts %>%
  mutate(log_OTU1 = log10(OTU_00001 + 1)) %>%
  ggplot(aes(log_OTU1)) +
  geom_histogram(bins = 30)
```
:::

##### Task 3

Plot OTU 1 against OTU 2 as a scatter plot using `geom_point`.

Remember to add 1 before log10 transformation of both variables.

::: {.callout-note collapse="true" appearance="simple"}
##### SOLUTION:

```{r, fig.width=4, fig.height=4}
#| out-width: "50%"
#| fig-align: "center"
counts %>%
  mutate(log_OTU1 = log10(OTU_00001 + 1)) %>%
  mutate(log_OTU2 = log10(OTU_00002 + 1)) %>%
  ggplot(aes(x = log_OTU1, y = log_OTU2)) +
  geom_point()
```
:::

##### Task 4

But what type of bacteria do these amplicon sequences belong to?

Look up the classifications of OTU 1 and OTU 2 in the taxonomy table.

::: {.callout-note collapse="true" appearance="simple"}
##### SOLUTION:

```{r}
taxonomy %>% filter(OTU %in% c("OTU_00001", "OTU_00002"))
```

```{r}
taxonomy %>%
  filter(OTU %in% c("OTU_00001", "OTU_00002")) %>%
  select(OTU, Phylum, Family, Genus) 
```
:::

##### Task 5

Now make histograms and look up the taxonomy for the next thousand OTUs...

::: {.callout-note collapse="true" appearance="simple"}
##### SOLUTION:

Okay, that was a joke. ü§°

It is possible to make a thousand plots, because R is very good at repetitive tasks.

But, this would not be very useful, because you could not look at them all.

In the next section of this practical, we will explore smarter ways to analyse microbiota compositions.
:::
:::

## Assemble a phyloseq üõ†Ô∏è

So far we have not used any R packages specialised for microbiome data.

Let's do so, because it will make our next tasks a lot easier!

```{r}
library(phyloseq)
library(microViz)
```

We will start by combining our three dataframes into one `phyloseq` object

### OTU counts + taxonomy

phyloseq uses row or column names to match OTUs across the count and taxonomy tables.

In addition, the taxonomy table must contain only taxonomic ranks in descending order, and the count table must be converted to a numeric matrix.

```{r}
count_matrix <- counts %>% select(-sample) %>% as.matrix()
rownames(count_matrix) <- counts$sample
```

```{r}
tax_matrix <- taxonomy %>% select(!OTU) %>% as.matrix()
rownames(tax_matrix) <- taxonomy$OTU
```

```{r}
ps <- phyloseq(
  otu_table(count_matrix, taxa_are_rows = FALSE), 
  tax_table(tax_matrix)
)
```

```{r}
ps
```

### Adding sample metadata

phyloseq uses row names to match samples (across the OTU count table and the sample metadata).

```{r}
head(sample_names(ps))
```

Notice that in the phyloseq object the sample names have underscores, but they have hyphens in the sample metadata.

```{r}
meta
```

We can fix that with the `stringr` package `str_replace` function.

```{r}
meta$sample <- meta$sample %>% str_replace(pattern = "-", replacement = "_")
meta
```

Now make them row names, check they all match, and add the metadata to the phyloseq object.

```{r}
meta_df <- as.data.frame(meta)
rownames(meta_df) <- meta$sample
all(rownames(meta_df) %in% sample_names(ps))
```

```{r}
sample_data(ps) <- meta_df
ps
```

## microViz ü¶†üëÅÔ∏è

microViz provides tools for working with phyloseq objects.

Let's take a look with some basic microViz functions.

```{r}
samdat_tbl(ps) # retrieve sample data as a tibble
```

```{r}
# get the OTU table, or part of it
otu_get(ps, taxa = 1:5, samples = c("132_AX", "166_AX", "102_AZ"))
```

```{r}
# get the taxonomy table
tt_get(ps) %>% head(3)
```

## Build some bar charts üìä

Sequencing data are compositional. The total number of reads per sample is mostly arbitrary, and so the counts should be interpreted as relative abundances instead of absolute abundances.

A simple way to visualise compositional data is as percentages, proportions of a whole.

Stacked bar charts are great for this: each bar represents one sample, and we can show the abundance data as proportions, after aggregating the counts by taxonomy.

```{r, message=FALSE}
#| fig-width: 8
#| fig-height: 2
ps %>% tax_fix() %>% comp_barplot("Phylum", n_taxa = 4, label = NULL)
```

This plot is aggregated into phyla, which is easy to read, and provides basic information.

We see that most samples contain a mixture of *Firmicutes* and *Bacteroidetes*, but some appear to be dominated by *Proteobacteria* instead.

::: {.callout-warning collapse="true"}
### Beware Fickle Phyla!

Beware, phylum names have changed recently!

-   *Actinobacteria* is now *Actinomycetota*
-   *Bacteroidetes* is now *Bacteroidota*
-   *Proteobacteria* is now *Pseudomonadota* (!)
-   *Firmicutes* is now *Bacillota* (!!)

In all prior research, you will see the original names, but in coming years, the new names will be increasingly adopted.

The best source for checking/searching official and alternative names is probably [LPSN at bacterio.net](https://www.bacterio.net/){target="_blank"}
:::

```{r, message=FALSE}
#| fig-width: 8
#| fig-height: 4
ps %>% tax_fix() %>% comp_barplot("Genus", n_taxa = 11, merge_other = F, label = NULL)
```

This plot is aggregated into genera, which provides more detail, but is harder to read, and we cannot give every genus a distinct colour.

We see that many samples contain a relatively large proportion of *Bacteroides* or *Faecalibacterium* but there is quite some further variation!

## Discover diversity üå≥üå≤üå¥

As a last task for this introductory session, we will calculate and visualise alpha diversity.

We will calculate Shannon diversity at the level of Genus. 

-   The Shannon index is a commonly used diversity measure, with this formula: $H = -\sum_{i=1}^Np_i\ln p_i$
-   Shannon index is often is denoted with $H$, and here $p$ denotes proportion of the $i$'th taxon.

::: {.callout-note collapse="true"}
### Explanation of the Shannon index formula

-   For each taxon $i$, you multiply its proportional abundance $p_i$ by the natural log of that proportion $\ln p_i$, and sum those values.
-   Try it out for yourself to convince yourself you get larger (negative) values for higher proportions.
-   The highest value you can achieve with $N$ taxa occurs with equal proportions
-   e.g. with 20 taxa, maximum diversity occurs if each has a proportion of 5%
-   Lastly, you change the sign of the result to a positive number, for ease of interpretation
-   This just makes more intuitive sense: as higher positive numbers indicates higher diversity.
:::

We will also compute a exponentiated version, the effective number of genera, or effective Shannon index.


::: {.callout-note collapse="true"}
### Explanation of the Effective Shannon Diversity

The exponent of the Shannon index $e^H$ represents the number of taxa (genera) that would be present in an evenly abundant ecosystem with the same Shannon index.

-   The numeric value of the Shannon index itself has no intuitive meaning.
-   You can compare them, but can't easily interpret any one number.
-   So, the concept of "effective numbers" of taxa is useful here.
-   If your original ecosystem was actually perfectly even, then $e^H = N$
-   Where N is the observed richness
-   The more uneven an ecosystem, the further $e^H$ will be from $N$

:::

```{r}
ps_alpha <- ps %>% 
  tax_fix() %>%
  ps_calc_diversity(index = "shannon", rank = "Genus", varname = "Shannon_Genus") %>% 
  ps_mutate(Effective_Shannon_Genus = exp(Shannon_Genus))

ps_alpha
```

The new genus-level Shannon diversity variables are stored in the sample data slot of `ps_alpha`

```{r}
ps_alpha %>% samdat_tbl() %>% select(sample, Shannon_Genus, Effective_Shannon_Genus)
```

```{r, fig.width=6, out.width="70%"}
ps_alpha %>% samdat_tbl() %>% pull(Shannon_Genus) %>% hist(main = "Shannon Diversity, Genus")
```

```{r, fig.width=6, out.width="70%"}
ps_alpha %>% samdat_tbl() %>% pull(Effective_Shannon_Genus) %>% hist(main = "Effective no. genera")
```


### Interpreting diversity

Now each sample is labelled with the effective Shannon diversity of genera ($e^H$) - do you see a relationship to sample composition?

```{r, message=FALSE, fig.height=11, fig.width=6, out.width="70%"}
#| fig-align: "center"
#| code-fold: true
ps_alpha %>% 
  ps_arrange(Effective_Shannon_Genus) %>% 
  ps_mutate(short_shannon = formatC(Effective_Shannon_Genus, digits = 2, format = "f")) %>% 
  comp_barplot(
    tax_level = "Genus", n_taxa = 19, merge_other = FALSE, 
    sample_order = "asis", label = "short_shannon"
  ) +
  coord_flip()
```


## Next! ‚è©

- Its time to stop exploring and take a break. 
- In the next lecture you will learn more about the main approaches for microbiota data analysis.
- In the next practical session, we will come back to these data with a plan, an analysis plan!

## Session info

<details>

```{r}
sessioninfo::session_info()
```

</details>
